from skimage import measure, morphology
from scipy import ndimage
from astropy.nddata import CCDData

from script_utils import calibration_folder, read_img_keys
from pathlib import Path
import tomllib
import os


def create_mask(img, sat_thresh=58_000):
    sat_mask = img.data > sat_thresh
    return create_closed_mask(sat_mask)


def create_closed_mask(sat_mask):
    # dialate to connect outline features
    mask = (ndimage.binary_dilation(sat_mask, iterations=4))
    
    mask = morphology.remove_small_holes(mask, max_size=20000)

    # dial back the dialation 
    mask = ndimage.binary_erosion(mask, iterations=3) 

    mask = mask | sat_mask # don't allow any previously masked pixels to remain

    mask = fill_small_convex_hulls(mask, 400)
    return mask


def fill_small_convex_hulls(binary_image, max_size):
    """Fill convex hulls of True regions smaller than max_size"""
    # Label connected components
    labeled = measure.label(binary_image, connectivity=2)
    
    # Create output image
    result = binary_image.copy()
    
    # Process each region
    for region in measure.regionprops(labeled):
        print("on region ", region)
        if region.area < max_size:
            # Get convex hull of this region
            convex_hull = morphology.convex_hull_image(region.image)
            
            # Place convex hull back into result image
            minr, minc, maxr, maxc = region.bbox
            result[minr:maxr, minc:maxc][convex_hull] = True
    
    return result



"""
Trims images in the `raw` folder based on 
the keys in `file_keys` placing new images in `newdir`
"""
def process_folder(file_keys, foldername):
    for name in file_keys.keys():
        if ("std_" in name) or ("obj_" in name):
            oldpath = foldername + "/trimmed/" + name
            newpath = foldername + "/flat_fielded/" + name.replace(".fits",
            ".mask.fits")

            if Path(newpath).is_file():
                os.remove(newpath)

            print("creating mask ", oldpath, " => ", newpath)
            img = CCDData.read(oldpath)
            img_new = CCDData(create_closed_mask(img), unit="adu")
            img_new.write(newpath)


def process_all(img_keys):
    for foldername, file_keys in img_keys.items():
        process_folder(file_keys, foldername)


def main():
    img_keys = read_img_keys()
    process_all(img_keys)


if __name__ == "__main__":
    main()
